---
title: ARO HCP Clusters
authors:
 - "@serngawy"
 - "@marek-veber"
reviewers:
 - ""
creation-date: 2025-04-23
last-updated: 2026-02-09
status: implemented
---


# Create ARO HCP Clusters


## Table of Contents


- [Introduction](#introduction)
- [Goals](#goals)
- [Non-Goals](#non-goals)
- [Proposal](#proposal)
- [User Stories](#user-stories)
- [Implementation Details](#implementation-details)
- [Risks and Mitigations](#risks-and-mitigations)
- [Graduation Criteria](#graduation-criteria)
- [Implementation History](#implementation-history)


## Introduction


The Cluster API Provider for Azure (CAPZ) extends Kubernetes Cluster API functionality to Microsoft Azure environments, facilitating the management and lifecycle of Kubernetes clusters on Azure. This proposal outlines the integration of Azure Red Hat OpenShift (ARO) Hybrid Cloud Platform (HCP) clusters within CAPZ using Azure Service Operator (ASO) for resource provisioning.

The implementation leverages ASO resources embedded directly in Custom Resource specifications, providing a declarative, Kubernetes-native approach to managing ARO HCP infrastructure.


## Goals


- **Integration**: Enable provisioning and management of ARO HCP clusters using CAPZ with ASO.
- **API Conformance**: Align CAPZ operations with ARO HCP API specifications via ASO resources.
- **Scalability**: Support scaling of ARO HCP clusters through CAPZ controllers.
- **Operational Excellence**: Provide seamless cluster lifecycle management, including creation, scaling, and deletion.
- **Declarative Infrastructure**: Use embedded ASO resources for infrastructure-as-code approach.


## Non-Goals


- Support for non-HCP Azure services not specified in the ARO HCP API.
- Field-based provisioning mode (deprecated and removed in favor of resources mode).


## Proposal


CAPZ introduces controllers and reconcilers to manage ARO HCP clusters using ASO (Azure Service Operator) resources. Instead of field-based specifications, infrastructure is defined declaratively using embedded ASO resource definitions in the `spec.resources` field.

This approach:
- Uses ASO's native resource types (HcpOpenShiftCluster, Vault, etc.)
- Provides full control over Azure resource configuration
- Eliminates dual-path provisioning logic
- Follows Kubernetes-native patterns for infrastructure management


Key capabilities include:


- **Cluster Provisioning**: Users define ARO HCP clusters declaratively via embedded ASO resources in the CRD. CAPZ controllers reconcile these resources using ASO.

- **Lifecycle Management**: Controllers handle scaling, upgrades, and deletion of ARO HCP clusters by reconciling ASO resources.

- **Dependency Management**: Proper sequencing ensures resources are ready before dependent resources are created (e.g., infrastructure ready before HCP cluster creation).


## User Stories


- As a Kubernetes operator, I want to deploy an ARO HCP cluster using Kubernetes-native ASO resources via CAPZ.
- As a platform engineer, I need declarative infrastructure management for ARO HCP clusters with full control over Azure resources.
- As a DevOps engineer, I want infrastructure-as-code for ARO HCP clusters that can be version-controlled and reviewed.


## Implementation Details


### Controller Architecture:


CAPZ implements three Custom Resource Definitions (CRDs) and their corresponding controllers to manage ARO HCP clusters:


#### AROControlPlane CRD

Represents the desired state of an ARO Hybrid Cloud Platform cluster's control plane. Uses embedded ASO resources for infrastructure provisioning.

```go
// AROControlPlane is the Schema for the AROControlPlane API.
type AROControlPlane struct {
 metav1.TypeMeta   `json:",inline"`
 metav1.ObjectMeta `json:"metadata,omitempty"`

 Spec   AROControlPlaneSpec   `json:"spec,omitempty"`
 Status AROControlPlaneStatus `json:"status,omitempty"`
}

type AROControlPlaneSpec struct {
 // Resources are embedded ASO resources to be managed by this AROControlPlane.
 // This allows you to define the full infrastructure including HcpOpenShiftCluster and
 // HcpOpenShiftClustersExternalAuth resources directly using ASO types.
 //
 // Required. Must include at minimum:
 // - HcpOpenShiftCluster resource
 // - HcpOpenShiftClustersExternalAuth resource (if external auth is needed)
 //
 // Example resources:
 // - redhatopenshift.azure.com/v1api20240610preview/HcpOpenShiftCluster
 // - redhatopenshift.azure.com/v1api20240610preview/HcpOpenShiftClustersExternalAuth
 Resources []runtime.RawExtension `json:"resources,omitempty"`

 // IdentityRef is a reference to an identity to be used when reconciling the ARO control plane.
 // If no identity is specified, the default identity for this controller will be used.
 IdentityRef *corev1.ObjectReference `json:"identityRef,omitempty"`

 // SubscriptionID is the GUID of the Azure subscription that owns this cluster.
 // Required for Azure API authentication and ARM resource ID construction.
 SubscriptionID string `json:"subscriptionID,omitempty"`

 // AzureEnvironment is the name of the AzureCloud to be used.
 // The default value that would be used by most users is "AzurePublicCloud", other values are:
 // - ChinaCloud: "AzureChinaCloud"
 // - PublicCloud: "AzurePublicCloud"
 // - USGovernmentCloud: "AzureUSGovernmentCloud"
 //
 // Note that values other than the default must also be accompanied by corresponding changes to the
 // aso-controller-settings Secret to configure ASO to refer to the non-Public cloud.
 AzureEnvironment string `json:"azureEnvironment,omitempty"`
}

type AROControlPlaneStatus struct {
 // Initialization status
 Initialization *AROControlPlaneInitializationStatus `json:"initialization,omitempty"`

 // Ready indicates that the AROControlPlane API Server is ready to receive requests.
 // Set to true when both HcpClusterReady condition is true AND kubeconfig exists.
 Ready bool `json:"ready"`

 // FailureMessage will be set in the event that there is a terminal problem
 FailureMessage *string `json:"failureMessage,omitempty"`

 // Conditions specifies the conditions for the managed control plane
 // Key conditions:
 // - HcpClusterReady: HCP cluster is fully operational
 // - EncryptionKeyReady: ETCD encryption key is ready (if encryption configured)
 // - ExternalAuthReady: External authentication is configured (if enabled)
 Conditions clusterv1.Conditions `json:"conditions,omitempty"`

 // Resources status for each ASO resource managed by this control plane
 Resources []ResourceStatus `json:"resources,omitempty"`

 // APIURL is the url for the ARO-HCP openshift cluster api endpoint.
 APIURL string `json:"apiURL,omitempty"`

 // Version is the ARO-HCP OpenShift semantic version, for example "4.20.0".
 Version string `json:"version,omitempty"`
}

type AROControlPlaneInitializationStatus struct {
 // ControlPlaneInitialized indicates whether or not the control plane has the
 // uploaded kubeconfig secret and the secret is valid.
 ControlPlaneInitialized bool `json:"controlPlaneInitialized,omitempty"`
}

type ResourceStatus struct {
 // Resource reference
 Resource corev1.ObjectReference `json:"resource"`

 // Ready indicates if the resource is ready
 Ready bool `json:"ready"`

 // Message provides details about the resource status
 Message string `json:"message,omitempty"`
}
```

An example of AROControlPlane CR using resources mode:

```yaml
apiVersion: controlplane.cluster.x-k8s.io/v1beta2
kind: AROControlPlane
metadata:
  name: my-cluster
  namespace: default
spec:
  identityRef:
    kind: AzureClusterIdentity
    name: aro-identity
    namespace: default
  subscriptionID: "00000000-0000-0000-0000-000000000000"
  azureEnvironment: "AzurePublicCloud"  # Optional, defaults to AzurePublicCloud
  resources:
    # HcpOpenShiftCluster - The main ARO HCP cluster resource
    - apiVersion: redhatopenshift.azure.com/v1api20240610preview
      kind: HcpOpenShiftCluster
      metadata:
        name: my-cluster
        namespace: default
      spec:
        azureName: my-cluster
        owner:
          name: my-cluster-resgroup
        location: eastus
        identity:
          type: UserAssigned
          userAssignedIdentities:
            - reference:
                armId: /subscriptions/.../userAssignedIdentities/my-cluster-cp-control-plane
        properties:
          api:
            visibility: Public
          clusterImageRegistry:
            state: Enabled
          etcd:
            dataEncryption:
              customerManaged:
                encryptionType: KMS
                kms:
                  activeKey:
                    name: etcd-data-kms-encryption-key
                    vaultName: my-cluster-kv
              keyManagementMode: CustomerManaged
          network:
            hostPrefix: 23
            machineCidr: "10.0.0.0/16"
            networkType: OVNKubernetes
            podCidr: "10.128.0.0/14"
            serviceCidr: "172.30.0.0/16"
          platform:
            managedResourceGroup: capz_node_my-cluster_rg
            networkSecurityGroupReference:
              group: network.azure.com
              kind: NetworkSecurityGroup
              name: my-cluster-nsg
            operatorsAuthentication:
              userAssignedIdentities:
                controlPlaneOperatorsReferences:
                  control-plane:
                    armId: /subscriptions/.../userAssignedIdentities/...
            outboundType: LoadBalancer
            subnetReference:
              group: network.azure.com
              kind: VirtualNetworksSubnet
              name: my-cluster-vnet-subnet
          version:
            channelGroup: stable
            id: "4.20"
        operatorSpec:
          secrets:
            adminCredentials:
              key: value
              name: my-cluster-kubeconfig

    # HcpOpenShiftClustersExternalAuth - Optional external authentication
    - apiVersion: redhatopenshift.azure.com/v1api20240610preview
      kind: HcpOpenShiftClustersExternalAuth
      metadata:
        name: my-cluster-ea
        namespace: default
      spec:
        azureName: my-cluster-ea
        owner:
          name: my-cluster  # References the HcpOpenShiftCluster
        properties:
          claim:
            mappings:
              groups:
                claim: groups
              username:
                claim: oid
                prefixPolicy: NoPrefix
          clients:
            - clientId: "51ed0256-1d54-46d4-9479-14ac212ca10f"
              component:
                authClientNamespace: openshift-console
                name: console
              extraScopes:
                - openid
                - profile
              type: Confidential
          issuer:
            audiences:
              - "51ed0256-1d54-46d4-9479-14ac212ca10f"
            url: "https://login.microsoftonline.com/<tenant-id>/v2.0"

status:
  initialization:
    controlPlaneInitialized: true
  ready: true
  conditions:
    - type: HcpClusterReady
      status: "True"
      reason: Succeeded
      message: HCP cluster is fully operational
    - type: EncryptionKeyReady
      status: "True"
      reason: KeyReady
      message: Encryption key 'etcd-data-kms-encryption-key' version 'abc123' ready in vault 'my-cluster-kv'
    - type: ExternalAuthReady
      status: "True"
      reason: Succeeded
      message: External authentication configured successfully
  resources:
    - resource:
        apiVersion: redhatopenshift.azure.com/v1api20240610preview
        kind: HcpOpenShiftCluster
        name: my-cluster
        namespace: default
      ready: true
      message: Cluster is provisioned and ready
  apiURL: "https://api.my-cluster.example.com:6443"
  version: "4.20.0"
```

#### AROMachinePool CRD

Represents the desired state of the worker nodes (compute node pools) using embedded ASO HcpOpenShiftClustersNodePool resources.

```go
// AROMachinePool is the Schema for the AROMachinePool API.
type AROMachinePool struct {
 metav1.TypeMeta   `json:",inline"`
 metav1.ObjectMeta `json:"metadata,omitempty"`

 Spec   AROMachinePoolSpec   `json:"spec,omitempty"`
 Status AROMachinePoolStatus `json:"status,omitempty"`
}

// AROMachinePoolSpec defines the desired spec of AROMachinePool.
type AROMachinePoolSpec struct {
 // Resources are embedded ASO resources to be managed by this AROMachinePool.
 // Must include HcpOpenShiftClustersNodePool resource.
 //
 // Example:
 // - redhatopenshift.azure.com/v1api20240610preview/HcpOpenShiftClustersNodePool
 Resources []runtime.RawExtension `json:"resources"`
}

// AROMachinePoolStatus defines the observed state of AROMachinePool.
type AROMachinePoolStatus struct {
 // Conditions specifies the conditions for the machine pool
 Conditions clusterv1.Conditions `json:"conditions,omitempty"`

 // Resources status for each ASO resource managed by this machine pool
 Resources []ResourceStatus `json:"resources,omitempty"`

 // Ready indicates that the AROMachinePool has joined the cluster
 Ready bool `json:"ready"`

 // FailureMessage will be set in the event that there is a terminal problem
 FailureMessage *string `json:"failureMessage,omitempty"`

 // Replicas are the most recently observed number of replicas
 Replicas int32 `json:"replicas"`
}
```

An example of AROMachinePool CR:

```yaml
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AROMachinePool
metadata:
  name: my-cluster-mp1
  namespace: default
spec:
  resources:
    - apiVersion: redhatopenshift.azure.com/v1api20240610preview
      kind: HcpOpenShiftClustersNodePool
      metadata:
        name: my-cluster-mp1
        namespace: default
      spec:
        azureName: my-cluster-mp1
        owner:
          name: my-cluster  # References the HcpOpenShiftCluster
        properties:
          autoRepair: true
          autoscaling:
            max: 10
            min: 2
          labels:
            node-role.kubernetes.io/worker: ""
          platform:
            diskSizeGiB: 120
            diskStorageAccountType: Premium_LRS
            subnetReference:
              group: network.azure.com
              kind: VirtualNetworksSubnet
              name: my-cluster-vnet-subnet
            vmSize: Standard_D4s_v3
          version:
            channelGroup: stable
            id: "4.20"
status:
  ready: true
  replicas: 5
  conditions:
    - type: Ready
      status: "True"
      reason: NodePoolReady
  resources:
    - resource:
        apiVersion: redhatopenshift.azure.com/v1api20240610preview
        kind: HcpOpenShiftClustersNodePool
        name: my-cluster-mp1
      ready: true
```

#### AROCluster CRD

Represents the infrastructure cluster, managing infrastructure resources via embedded ASO resources.

```go
// AROCluster is the Schema for the AROClusters API.
type AROCluster struct {
 metav1.TypeMeta   `json:",inline"`
 metav1.ObjectMeta `json:"metadata,omitempty"`

 Spec   AROClusterSpec   `json:"spec,omitempty"`
 Status AROClusterStatus `json:"status,omitempty"`
}

// AROClusterSpec defines the desired spec of AROCluster.
type AROClusterSpec struct {
 // Resources are embedded ASO resources to be managed by this AROCluster.
 // Typically includes infrastructure resources like:
 // - ResourceGroup
 // - VirtualNetwork
 // - Subnet
 // - NetworkSecurityGroup
 // - Vault (for encryption)
 // - UserAssignedIdentity resources
 //
 // These resources are provisioned before the HcpOpenShiftCluster.
 Resources []runtime.RawExtension `json:"resources,omitempty"`

 // ControlPlaneEndpoint represents the endpoint used to communicate with the control plane.
 // Set by the controller from AROControlPlane status.
 ControlPlaneEndpoint clusterv1.APIEndpoint `json:"controlPlaneEndpoint"`

 // SubscriptionID is the Azure subscription ID for the cluster
 SubscriptionID string `json:"subscriptionID"`

 // IdentityRef is a reference to an identity to be used when reconciling resources.
 IdentityRef *corev1.ObjectReference `json:"identityRef,omitempty"`
}

// AROClusterStatus defines the observed state of AROCluster.
type AROClusterStatus struct {
 // Initialization status
 Initialization *AROClusterInitializationStatus `json:"initialization,omitempty"`

 // Ready is when the infrastructure and control plane are ready.
 Ready bool `json:"ready,omitempty"`

 // Conditions define the current service state of the AROCluster.
 // Key conditions:
 // - ResourcesReady: All infrastructure resources are ready
 // - NetworkInfrastructureReady: Network infrastructure is ready
 Conditions clusterv1.Conditions `json:"conditions,omitempty"`

 // Resources status for each ASO resource managed by this cluster
 Resources []ResourceStatus `json:"resources,omitempty"`
}

type AROClusterInitializationStatus struct {
 // Provisioned indicates whether infrastructure is provisioned.
 // Set to true when:
 // 1. All infrastructure resources are ready (ResourcesReady condition)
 // 2. AROControlPlane is ready (HcpClusterReady + kubeconfig exists)
 // This gates CAPI from attempting to connect before the cluster is actually ready.
 Provisioned bool `json:"provisioned,omitempty"`
}
```

An example of AROCluster CR:

```yaml
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AROCluster
metadata:
  name: my-cluster
  namespace: default
spec:
  subscriptionID: "00000000-0000-0000-0000-000000000000"
  controlPlaneEndpoint:
    host: api.my-cluster.example.com
    port: 6443
  identityRef:
    kind: AzureClusterIdentity
    name: aro-identity
  resources:
    # ResourceGroup
    - apiVersion: resources.azure.com/v1api20200601
      kind: ResourceGroup
      metadata:
        name: my-cluster-resgroup
        namespace: default
      spec:
        azureName: my-cluster-resgroup
        location: eastus

    # VirtualNetwork
    - apiVersion: network.azure.com/v1api20201101
      kind: VirtualNetwork
      metadata:
        name: my-cluster-vnet
        namespace: default
      spec:
        azureName: my-cluster-vnet
        owner:
          name: my-cluster-resgroup
        location: eastus
        properties:
          addressSpace:
            addressPrefixes:
              - "10.0.0.0/16"

    # Subnet
    - apiVersion: network.azure.com/v1api20201101
      kind: VirtualNetworksSubnet
      metadata:
        name: my-cluster-vnet-subnet
        namespace: default
      spec:
        azureName: my-cluster-subnet
        owner:
          name: my-cluster-vnet
        properties:
          addressPrefix: "10.0.0.0/24"

    # NetworkSecurityGroup
    - apiVersion: network.azure.com/v1api20201101
      kind: NetworkSecurityGroup
      metadata:
        name: my-cluster-nsg
        namespace: default
      spec:
        azureName: my-cluster-nsg
        owner:
          name: my-cluster-resgroup
        location: eastus

    # KeyVault for encryption
    - apiVersion: keyvault.azure.com/v1api20230701
      kind: Vault
      metadata:
        name: my-cluster-kv
        namespace: default
      spec:
        azureName: my-cluster-kv
        owner:
          name: my-cluster-resgroup
        location: eastus
        properties:
          sku:
            family: A
            name: standard
          tenantId: "00000000-0000-0000-0000-000000000000"
          enableRbacAuthorization: true
          enableSoftDelete: true

    # User Assigned Identities (example - multiple needed for ARO)
    - apiVersion: managedidentity.azure.com/v1api20230131
      kind: UserAssignedIdentity
      metadata:
        name: my-cluster-cp-control-plane
        namespace: default
      spec:
        azureName: my-cluster-cp-control-plane
        owner:
          name: my-cluster-resgroup
        location: eastus

status:
  initialization:
    provisioned: true
  ready: true
  conditions:
    - type: ResourcesReady
      status: "True"
      reason: InfrastructureReady
      message: "All 7 infrastructure resources are ready"
    - type: NetworkInfrastructureReady
      status: "True"
      reason: Succeeded
  resources:
    - resource:
        kind: ResourceGroup
        name: my-cluster-resgroup
      ready: true
    - resource:
        kind: VirtualNetwork
        name: my-cluster-vnet
      ready: true
    # ... other resources
```

### Controller Responsibilities

Each controller is responsible for:

#### AROControlPlane Controller

- Watches `AROControlPlane` resources
- Reconciles embedded ASO resources (HcpOpenShiftCluster, HcpOpenShiftClustersExternalAuth)
- Manages encryption key creation via keyvaults service
- Updates resource status based on ASO resource conditions
- Sets `Ready` status when:
  1. HcpClusterReady condition is True (from ASO)
  2. Kubeconfig secret exists
- Sets `ControlPlaneInitialized` when both conditions above are met
- Applies mutators to:
  - Set defaults on HcpOpenShiftCluster
  - Inject encryption key version
  - Set owner references

Key features:
- **Dependency Management**: Waits for AROCluster infrastructure (ResourcesReady condition) before creating HcpOpenShiftCluster
- **ExternalAuth Deferral**: Uses resource filtering to defer ExternalAuth creation until NodePool is ready to avoid Azure API errors
- **Encryption Key Management**: Uses keyvaults service to create/retrieve encryption keys, sets version in HcpOpenShiftCluster via mutator
- **Condition Tracking**:
  - `HcpClusterReady`: HCP cluster operational status
  - `EncryptionKeyReady`: Encryption key status (if configured)
  - `ExternalAuthReady`: External auth status (if configured)

#### AROMachinePool Controller

- Watches `AROMachinePool` resources
- Reconciles embedded ASO HcpOpenShiftClustersNodePool resources
- Waits for AROControlPlane to be ready before creating node pools
- Updates resource status based on ASO resource conditions
- Applies mutators to set defaults and owner references

#### AROCluster Controller

- Watches `AROCluster` resources
- Reconciles embedded ASO infrastructure resources (ResourceGroup, VNet, Subnet, NSG, Vault, Identities)
- Tracks infrastructure readiness via `ResourcesReady` condition
- Mirrors AROControlPlane endpoint to spec.controlPlaneEndpoint
- Sets `Initialization.Provisioned` when:
  1. ResourcesReady condition is True
  2. AROControlPlane.Ready is True
- This gates CAPI from connecting before the cluster is truly ready

### Dependency Chain

The proper dependency sequence ensures resources are created in the correct order:

```
1. AROCluster infrastructure resources created
   ↓
2. ResourcesReady condition becomes True
   ↓
3. HcpOpenShiftCluster created (waits for step 2)
   ↓
4. HcpClusterReady condition becomes True
   ↓
5. Kubeconfig secret created by ASO
   ↓
6. AROControlPlane.Ready becomes True (checks steps 4 & 5)
   ↓
7. AROCluster.Ready becomes True
   ↓
8. AROCluster.Initialization.Provisioned becomes True
   ↓
9. CAPI Cluster.InfrastructureProvisioned becomes True
   ↓
10. CAPI connects to cluster
```

This dependency chain **eliminates CAPI kubeconfig errors** by ensuring the kubeconfig exists before CAPI attempts to connect.

### Syncing Between Controllers

- **Ownership and References**:
  - ASO resources use `owner` references to link resources (e.g., NodePool → HcpOpenShiftCluster)
  - CAPI resources use `ownerReferences` for cascading deletes
  - AROMachinePool references AROControlPlane via cluster name

- **Reconciliation Ordering**:
  - AROCluster resources must be ready before AROControlPlane creates HcpOpenShiftCluster
  - AROControlPlane must be ready before AROMachinePool creates NodePools
  - Controllers watch related resources and requeue when dependencies change

- **Status Propagation**:
  - Resource statuses are aggregated into CRD conditions
  - Parent resources track child resource readiness
  - CAPI Cluster reflects AROCluster initialization status

- **Error Handling and Retries**:
  - Controllers use exponential backoff for transient errors
  - ASO handles Azure API rate limiting and retries
  - Terminal errors are surfaced in status conditions

### Resources Mode Architecture

The implementation uses a **resources-only mode** where all infrastructure is defined using embedded ASO resources:

**Benefits:**
- **Declarative**: Full infrastructure as code
- **Flexible**: Direct access to all ASO resource properties
- **Version controlled**: Resources can be managed in git
- **Type-safe**: Uses ASO's generated types
- **Consistent**: Same pattern for all Azure resources

**Implementation:**
- ASO resources are embedded in `spec.resources` as RawExtension
- Controllers convert RawExtension to Unstructured for processing
- Mutators apply defaults and inject dynamic values (e.g., encryption key version)
- ResourceReconciler manages ASO resource lifecycle
- Status tracking reports on each resource's readiness

### KeyVault Service

While most resources are managed via ASO, the **keyvaults service** is retained for encryption key management:

**Why keep keyvaults service:**
- ASO manages the Vault **resource** (the vault itself)
- Azure SDK (via keyvaults service) manages **keys within the vault**
- ASO doesn't support key version retrieval
- Key version must be injected into HcpOpenShiftCluster spec

**How it works:**
1. Vault resource created via ASO (in AROCluster.spec.resources)
2. keyvaults service creates/retrieves encryption key
3. Key version stored in scope via SetVaultInfo()
4. Mutator injects key version into HcpOpenShiftCluster spec
5. HcpOpenShiftCluster references the key for ETCD encryption

### Azure Resource Management

- **ASO (Azure Service Operator)**: Primary method for resource provisioning
  - HcpOpenShiftCluster
  - HcpOpenShiftClustersNodePool
  - HcpOpenShiftClustersExternalAuth
  - ResourceGroup, VirtualNetwork, Subnet, NetworkSecurityGroup
  - Vault, UserAssignedIdentity

- **Azure SDK**: Used only for encryption key management
  - KeyVault keys (create/retrieve key versions)

### Validation and Testing

- Unit tests for controller reconciliation logic
- Integration tests for ASO resource creation
- E2E tests for full cluster lifecycle
- Validation of proper dependency sequencing
- Testing of error conditions and recovery

## Risks and Mitigations

- **ASO API Changes**: Monitor ASO releases and update resource definitions accordingly
- **Azure API Changes**: ARO HCP API changes will require ASO updates
- **Security**: Use managed identities and RBAC for Azure resource access
- **Dependency Timing**: Proper condition checking prevents premature resource creation
- **Resource Cleanup**: Owner references ensure cascading deletion of related resources

## Graduation Criteria

- ✅ Successful provisioning of ARO HCP clusters using resources mode
- ✅ Proper dependency chain implementation preventing CAPI errors
- ✅ Validation against Azure and Kubernetes integration benchmarks
- ✅ Encryption key management working correctly
- ✅ ExternalAuth configuration functioning properly
- ✅ Clean code with field-based mode removed (~5,400 lines removed)

## Implementation History

- 2025-04-23: Initial proposal
- 2025-04-25: Proposal marked as implementable
- 2026-02-05: Implementation completed with resources mode
- 2026-02-07: Dependency chain refactored for proper sequencing
- 2026-02-08: Field-based provisioning code removed, proposal updated to reflect current implementation
- 2026-02-09: AROControlPlaneSpec field cleanup - removed redundant fields (domainPrefix, version, channelGroup, versionGate, additionalTags) that duplicated ASO resource configuration. Retained only functionally required fields: Resources, IdentityRef, SubscriptionID, AzureEnvironment. This simplifies the API and enforces resources-only mode where all cluster configuration is defined in embedded ASO resources.
